# ESG Dashboard API

## Overview

This document outlines the API endpoints designed to provide aggregated and formatted ESG (Environmental, Social, Governance) data for dashboard visualization and reporting. The current implementation focuses on greenhouse gas (GHG) emissions data.

The dashboard API provides:
1. **Aggregated Totals:** Total emissions with breakdowns by scope, category, and subcategory
2. **Time Series Data:** Emissions over time with flexible period options (monthly, quarterly, annual)

These endpoints retrieve data from the `CalculatedEmissionValue` records generated by the emission calculation framework, allowing visualization of the results without requiring complex query logic in frontend applications.

## API Endpoints

### 1. Total Emissions

**Endpoint:** `/api/dashboard/total-emissions/`

**Method:** GET

**Description:** Returns total emissions with comprehensive breakdowns by scope, category, and subcategory.

**Query Parameters:**
- `assignment_id`: Filter by template assignment ID
- `layer_id`: Filter by organization/layer ID
- `year`: Filter by reporting year
- `start_date`: Filter by start date (YYYY-MM-DD)
- `end_date`: Filter by end date (YYYY-MM-DD)
- `level`: Filter by aggregation level (M=monthly, A=annual)

**Response Format:**
```json
{
  "total_emissions": 1250.45,
  "unit": "kgCO2e",
  "by_scope": [
    {
      "emission_scope": "1",
      "total": 450.23,
      "percentage": 36.01
    },
    {
      "emission_scope": "2",
      "total": 800.22,
      "percentage": 63.99
    }
  ],
  "by_category": [
    {
      "category": "electricity",
      "total": 800.22,
      "percentage": 63.99
    },
    {
      "category": "transport",
      "total": 450.23,
      "percentage": 36.01
    }
  ],
  "by_subcategory": [
    {
      "category": "electricity",
      "subcategory": "hk_clp",
      "total": 500.12,
      "percentage": 40.00
    },
    {
      "category": "electricity",
      "subcategory": "hk_hke",
      "total": 300.10,
      "percentage": 23.99
    },
    {
      "category": "transport",
      "subcategory": "company_gasoline",
      "total": 450.23,
      "percentage": 36.01
    }
  ],
  "filters_applied": {
    "assignment_id": 123,
    "layer_id": 45,
    "year": 2023,
    "start_date": null,
    "end_date": null,
    "level": "A"
  }
}
```

### 2. Emissions Time Series

**Endpoint:** `/api/dashboard/emissions-time-series/`

**Method:** GET

**Description:** Returns emissions data over time for trend analysis, with configurable time periods.

**Query Parameters:**
- `period`: Aggregation period (monthly, quarterly, annual). Default: monthly
- `assignment_id`: Filter by template assignment ID
- `layer_id`: Filter by organization/layer ID
- `year`: Filter by reporting year
- `scope`: Filter by emission scope (1, 2, 3)
- `category`: Filter by emission category
- `subcategory`: Filter by emission subcategory
- `start_date`: Filter by start date (YYYY-MM-DD)
- `end_date`: Filter by end date (YYYY-MM-DD)
- `level`: Filter by aggregation level (M=monthly, A=annual)

**Response Format:**
```json
{
  "time_series": [
    {
      "period_date": "2023-01-01",
      "emission_scope": "1",
      "total": 35.23
    },
    {
      "period_date": "2023-01-01",
      "emission_scope": "2",
      "total": 65.87
    },
    {
      "period_date": "2023-02-01",
      "emission_scope": "1",
      "total": 38.41
    },
    {
      "period_date": "2023-02-01",
      "emission_scope": "2",
      "total": 68.12
    }
  ],
  "unit": "kgCO2e",
  "period": "monthly",
  "filters_applied": {
    "assignment_id": null,
    "layer_id": 45,
    "year": 2023,
    "scope": null,
    "category": null,
    "subcategory": null,
    "start_date": null,
    "end_date": null,
    "level": null
  }
}
```

## Usage Examples

### Total Emissions Examples

1. **Get total emissions for a specific year:**
```
GET /api/dashboard/total-emissions/?year=2023
```

2. **Get total emissions for a specific layer/organization:**
```
GET /api/dashboard/total-emissions/?layer_id=45
```

3. **Get total emissions for a specific assignment with annual aggregation:**
```
GET /api/dashboard/total-emissions/?assignment_id=123&level=A
```

4. **Get total emissions for a specific date range:**
```
GET /api/dashboard/total-emissions/?start_date=2023-01-01&end_date=2023-12-31
```

### Time Series Examples

1. **Get monthly emissions for a specific year:**
```
GET /api/dashboard/emissions-time-series/?year=2023&period=monthly
```

2. **Get quarterly emissions for a specific scope:**
```
GET /api/dashboard/emissions-time-series/?period=quarterly&scope=2
```

3. **Get annual emissions for a specific category:**
```
GET /api/dashboard/emissions-time-series/?period=annual&category=electricity
```

4. **Get monthly emissions for a specific layer with date range:**
```
GET /api/dashboard/emissions-time-series/?layer_id=45&start_date=2023-01-01&end_date=2023-12-31
```

## Implementation Details

The dashboard API is implemented in the following files:

- **Service Functions:** `data_management/services/dashboard.py`
- **API Views:** `data_management/views/dashboard_api.py`
- **URL Configuration:** `data_management/urls.py`

The endpoints use Django's ORM for efficient database queries and include parameter validation, error handling, and comprehensive logging.

## Security

- All dashboard endpoints require user authentication using DRF's `IsAuthenticated` permission class, consistent with other API endpoints.
- The endpoints are read-only (HTTP GET method only).
- Error handling prevents exposing sensitive information in error messages.

## Future Enhancements

Potential future enhancements to the dashboard API:

1. **Emission Intensity:** Add endpoints for emissions per business metric (revenue, floor area, employees) once business metric data is available.
2. **Target Comparison:** Add endpoints for comparing emissions against defined targets or baselines.
3. **Caching:** Implement response caching to improve performance for frequently accessed dashboard data.
4. **Pollutant and Energy Dashboards:** Add equivalent endpoints for pollutant and energy data once those calculation services are implemented.
5. **Data Export:** Add endpoints for exporting dashboard data in various formats (CSV, Excel). 